#!/bin/sh

#
# libUART
#
# Easy to use library for accessing the UART
#
# Copyright (c) 2025 Johannes Krottmayer <krotti83@proton.me>
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#

_SCRIPT_VERSION="v0.1.0.0"
_SCRIPT_DEFAULT=0

_CONFIG_OS=0
_CONFIG_MACHINE=0
_CONFIG_VERSION="v0.1.0.0"
_CONFIG_SIZEOF_SIZET=0
_CONFIG_SIZEOF_INT=0
_CONFIG_SIZEOF_LONGINT=0
_CONFIG_SIZEOF_FLOAT=0
_CONFIG_SIZEOF_DOUBLE=0
_CONFIG_SIZEOF_LONGDOUBLE=0

_BUILD_INTREE=1
_BUILD_CURDIR="."
_BUILD_SRCDIR="."
_BUILD_DIR="./build"
_BUILD_CONFIG="config.mk"
_BUILD_MAKEFILE="Makefile"
_BUILD_DOC=0
_BUILD_STATIC=1
_BUILD_SHARED=1
_BUILD_COMPILER=gcc
_BUILD_OS=linux

_INSTALL_PREFIX=/usr/local
_INSTALL_INCDIR="$_INSTALL_PREFIX/include"
_INSTALL_LIBDIR="$_INSTALL_PREFIX/lib64"
_INSTALL_SHAREDIR="$_INSTALL_PREFIX/share/libUART"
_INSTALL_DOCDIR="$_INSTALL_PREFIX/doc/libUART"

# Cleanup
cleanup()
{
    unset _SCRIPT_VERSION
    unset _SCRIPT_DEFAULT
    
    unset _CONFIG_OS
    unset _CONFIG_MACHINE
    unset _CONFIG_VERSION
    unset _CONFIG_SIZEOF_SIZET
    unset _CONFIG_SIZEOF_INT
    unset _CONFIG_SIZEOF_LONGINT
    unset _CONFIG_SIZEOF_FLOAT
    unset _CONFIG_SIZEOF_DOUBLE
    unset _CONFIG_SIZEOF_LONGDOUBLE
    
    unset _BUILD_INTREE
    unset _BUILD_CURDIR
    unset _BUILD_SRCDIR
    unset _BUILD_DIR
    unset _BUILD_CONFIG
    unset _BUILD_MAKEFILE
    unset _BUILD_DOC
    unset _BUILD_STATIC
    unset _BUILD_SHARED
    unset _BUILD_COMPILER
    unset _BUILD_OS
    
    unset _INSTALL_PREFIX
    unset _INSTALL_INCDIR
    unset _INSTALL_LIBDIR
    unset _INSTALL_SHAREDIR
    unset _INSTALL_DOCDIR
}

show_usage()
{
    _SCRIPT=$0
    echo "usage: $_SCRIPT [OPTION]... [VAR=VALUE]..."
    
    unset _SCRIPT
}

show_help()
{
    echo "\`configure\` configures libUART"
    echo
    show_usage
    echo
    echo "Configuration:"
    echo "  -H, --help              display this help and exit"
    echo "  -V, --version           display version information and exit"
    echo "  --target=OS             build for target operating system"
    echo "                          [default=$_BUILD_OS]"
    echo "  --compiler=COMPILER     build with specific compiler"
    echo "                          [default=$_BUILD_COMPILER]"
    echo
    echo "Installation directories:"
    echo "  --prefix=PREFIX         install architecture-independent files in PREFIX"
    echo "                          [default=$_INSTALL_PREFIX]"
    echo
    echo "Optional Features:"
    echo "  --enable-doc            enable building the PDF documentation [default=no]"
    echo "  --disable-static        disable static library building [default=yes]"
    echo "  --disable-shared        disable shared library building [default=yes]"
}

# Check make utility
check_make()
{
    echo -n "checking for make... "
    _RESULT=$(which make)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
    
    unset _RESULT
}

# Check build directory, if in-tree
check_build()
{
    _PATH=$(dirname $0)
    
    if [ $_PATH -eq "." ]
    then
        _BUILD_INTREE=1
        mkdir -p build
    else
        _BUILD_INTREE=0
    fi
    
    _BUILD_CURDIR=$(pwd)
    
    unset _PATH
}

# Check compiler suite (GCC)
check_compiler_gnu()
{
    # Simple check for C preprocessor
    echo -n "checking for GNU C preprocessor (cpp)... "
    _RESULT=$(which cpp)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
    
    # Simple check for GCC
    echo -n "checking for GNU C compiler (gcc)... "
    _RESULT=$(which gcc)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
    
    # Simple check if GCC can compile and link
    echo -n "checking whether GNU C compiler (gcc) works... "
    echo "int foo(void){return 0;}" > /tmp/configure_test.c
    gcc -c -o /tmp/configure_test.o /tmp/configure_test.c
    
    if [ $? -ne 0 ]
    then
        echo "failed"
        exit 1
    else
        echo "yes"
        rm -Rf /tmp/configure_test.o
    fi
    
    rm -Rf $BUILD_DIR/tmp.c
}

# Check compiler suite for Windows (GCC)
check_compiler_gnu_win()
{
    # Simple check for C preprocessor
    echo -n "checking for GNU C preprocessor (cpp)... "
    _RESULT=$(which x86_64-w64-mingw32-cpp)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    # Simple check for GCC
    echo -n "checking for GNU C compiler (gcc)... "
    _RESULT=$(which x86_64-w64-mingw32-gcc)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    # Simple check if GCC can compile and link
    echo -n "checking whether GNU C compiler (gcc) works... "
    echo "int foo(void){return 0;}" > /tmp/configure_test.c
    x86_64-w64-mingw32-gcc -c -o /tmp/configure_test.o /tmp/configure_test.c

    if [ $? -ne 0 ]
    then
        echo "failed"
        exit 1
    else
        echo "yes"
        rm -Rf /tmp/configure_test.o
    fi

    rm -Rf $BUILD_DIR/tmp.c
}

# Check compiler suite (LLVM clang)
check_compiler_llvm()
{
    # Simple check for GCC
    echo -n "checking for LLVM C compiler (clang)... "
    _RESULT=$(which clang)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    # Simple check if GCC can compile and link
    echo -n "checking whether LLVM C compiler (clang) works... "
    echo "int foo(void){return 0;}" > /tmp/configure_test.c
    clang -c -o /tmp/configure_test.o /tmp/configure_test.c

    if [ $? -ne 0 ]
    then
        echo "failed"
        exit 1
    else
        echo "yes"
        rm -Rf /tmp/configure_test.o
    fi

    rm -Rf $BUILD_DIR/tmp.c
}

check_binutils_gnu()
{
    echo -n "checking for GNU Assembler (as)... "
    _RESULT=$(which as)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
    
    echo -n "checking for GNU linker (ld)... "
    _RESULT=$(which ld)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
    
    echo -n "checking for GNU archiver (ar)... "
    _RESULT=$(which ar)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
    
    echo -n "checking for GNU objdump (objdump)... "
    _RESULT=$(which objdump)
    
    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
}

check_binutils_gnu_win()
{
    echo -n "checking for GNU Assembler (as)... "
    _RESULT=$(which x86_64-w64-mingw32-as)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for GNU linker (ld)... "
    _RESULT=$(which x86_64-w64-mingw32-ld)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for GNU archiver (ar)... "
    _RESULT=$(which x86_64-w64-mingw32-ar)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for GNU objdump (objdump)... "
    _RESULT=$(which x86_64-w64-mingw32-objdump)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for GNU windres (windres)... "
    _RESULT=$(which x86_64-w64-mingw32-windres)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
}

check_binutils_llvm()
{
    echo -n "checking for LLVM Assembler (llvm-as)... "
    _RESULT=$(which llvm-as)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for LLVM linker (lld)... "
    _RESULT=$(which lld)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for LLVM archiver (llvm-ar)... "
    _RESULT=$(which llvm-ar)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi

    echo -n "checking for LLVM objdump (llvm-objdump)... "
    _RESULT=$(which llvm-objdump)

    if [ $? -ne 0 ]
    then
        echo "failed (might not installed)"
        exit 1
    else
        echo $_RESULT
    fi
}

# Simple check if LaTeX PDF compiler is available (optional)
check_pdflatex()
{
    echo -n "checking for LaTeX PDF compiler (pdflatex)... "
    _RESULT=$(which pdflatex)
    
    if [ $? -ne 0 ]
    then
        if [ $_BUILD_DOC -ne 0 ]
        then
            echo "failed (might not installed)"
            exit 1
        else
            echo "warning (not needed)"
        fi
    else
        echo $_RESULT
    fi
    
    unset _RESULT
}

# Generate libJPMath config.mk
generate_config()
{
    echo -n "generating config.mk... "
    mkdir -p $_BUILD_DIR
    rm -f $_BUILD_DIR/$_BUILD_CONFIG
    echo "# libUART config.mk: Auto-generated: Please do not edit!!!" > $_BUILD_DIR/$_BUILD_CONFIG
    echo >> $_BUILD_DIR/$_BUILD_CONFIG
    echo "CONFIG_CONFIGURED = yes" >> $_BUILD_DIR/$_BUILD_CONFIG

    if [ "$_BUILD_OS" = "linux" ]
    then
        echo "CONFIG_BUILD_OS = linux" >> $_BUILD_DIR/$_BUILD_CONFIG
    elif [ "$_BUILD_OS" = "windows" ]
    then
        echo "CONFIG_BUILD_OS = win32" >> $_BUILD_DIR/$_BUILD_CONFIG
    fi

    if [ "$_BUILD_COMPILER" = "gcc" ]
    then
        echo "CONFIG_BUILD_COMPILER = gcc" >> $_BUILD_DIR/$_BUILD_CONFIG
    elif [ "$_BUILD_COMPILER" = "clang" ]
    then
        echo "CONFIG_BUILD_COMPILER = clang" >> $_BUILD_DIR/$_BUILD_CONFIG
    fi

    if [ $_BUILD_DOC -eq 1 ]
    then
        echo "CONFIG_BUILD_DOC = yes" >> $_BUILD_DIR/$_BUILD_CONFIG
    else
        echo "CONFIG_BUILD_DOC = no" >> $_BUILD_DIR/$_BUILD_CONFIG
    fi

    if [ $_BUILD_STATIC -eq 1 ]
    then
        echo "CONFIG_BUILD_STATIC = yes" >> $_BUILD_DIR/$_BUILD_CONFIG
    else
        echo "CONFIG_BUILD_STATIC = no" >> $_BUILD_DIR/$_BUILD_CONFIG
    fi

    if [ $_BUILD_SHARED -eq 1 ]
    then
        echo "CONFIG_BUILD_SHARED = yes" >> $_BUILD_DIR/$_BUILD_CONFIG
    else
        echo "CONFIG_BUILD_SHARED = no" >> $_BUILD_DIR/$_BUILD_CONFIG
    fi

    echo "CONFIG_GIT_VERSION = $(sh ./scripts/git_version.sh)" >> $_BUILD_DIR/$_BUILD_CONFIG

    echo "INSTALL_PREFIX = $_INSTALL_PREFIX" >> $_BUILD_DIR/$_BUILD_CONFIG
    echo "INSTALL_INCDIR = $_INSTALL_INCDIR" >> $_BUILD_DIR/$_BUILD_CONFIG
    echo "INSTALL_LIBDIR = $_INSTALL_LIBDIR" >> $_BUILD_DIR/$_BUILD_CONFIG
    echo "INSTALL_DOCDIR = $_INSTALL_DOCDIR" >> $_BUILD_DIR/$_BUILD_CONFIG
    
    echo "done"
}

if [ $# -eq 0 ]
then
    _SCRIPT_DEFAULT=1
else
    while [ $# -ne 0 ]
    do
        case $1 in
        -H|--help)
            show_help
            cleanup
            exit 1
            ;;
        -V|--version)
            show_version
            cleanup
            exit 1
            ;;
        --prefix=*)
            _INSTALL_PREFIX=$(echo $1 | sed 's/^--prefix=\([[:print:]]\+\)/\1/g')
            shift
            ;;
        --target=*)
            _BUILD_OS=$(echo $1 | sed 's/^--target=\([[:print:]]\+\)/\1/g')
            shift
            ;;
        --compiler=*)
            _BUILD_COMPILER=$(echo $1 | sed 's/^--compiler=\([[:print:]]\+\)/\1/g')
            shift
            ;;
        --enable-doc)
            _BUILD_DOC=1
            shift
            ;;
        --disable-static)
            _BUILD_STATIC=0
            shift
            ;;
        --disable-shared)
            _BUILD_SHARED=0
            shift
            ;;
        *)
            echo -n "unknown option... "
            echo $1
            show_usage
            cleanup
            exit 1
            ;;
        esac
    done
fi

echo -n "build OS... "
uname -o
echo -n "build machine... "
uname -m

if [ "$_BUILD_OS" = "windows" ]
then
    if [ "$_BUILD_COMPILER" = "clang" ]
    then
        echo "Building libUART for Windows with clang currently not supported!!!"
        exit 1
    elif [ "$_BUILD_COMPILER" = "gcc" ]
    then
        check_make
        check_binutils_gnu_win
        check_compiler_gnu_win
    else
        echo "Unsupported compiler suite ($_BUILD_COMPILER)!!!"
        exit 1
    fi
elif [ "$_BUILD_OS" = "linux" ]
then
    if [ "$_BUILD_COMPILER" = "gcc" ]
    then
        check_make
        check_binutils_gnu
        check_compiler_gnu
    elif [ "$_BUILD_COMPILER" = "clang" ]
    then
        check_make
        check_binutils_llvm
        check_compiler_llvm
    else
        echo "Unsupported compiler suite ($_BUILD_COMPILER)!!!"
        exit 1
    fi
else
    echo "Unsupported target operating system ($_BUILD_OS)!!!"
    exit 1
fi

check_pdflatex
generate_config
echo "execute command make"
cleanup

exit 0
